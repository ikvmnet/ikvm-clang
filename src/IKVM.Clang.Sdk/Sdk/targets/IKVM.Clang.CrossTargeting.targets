<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
    <PropertyGroup>
        <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
    </PropertyGroup>

    <PropertyGroup>
        <ClangDesignTimeTargetsPath Condition=" '$(ClangDesignTimeTargetsPath)' == '' ">$(MSBuildThisFileDirectory)IKVM.Clang.DesignTime.targets</ClangDesignTimeTargetsPath>
    </PropertyGroup>
    <Import Project="$(ClangDesignTimeTargetsPath)" />

    <Target Name="_ComputeInnerBuildProjects">
        <ItemGroup>
            <_TargetMachine Include="$(TargetMachines)" />
            <_TargetMachineNormalized Include="@(_TargetMachine->Trim()->Distinct())" />
            <_InnerBuildProjects Include="$(MSBuildProjectFile)">
                <AdditionalProperties>TargetMachine=%(_TargetMachineNormalized.Identity)</AdditionalProperties>
            </_InnerBuildProjects>
        </ItemGroup>
    </Target>
    
    <Target Name="DispatchToInnerBuilds" DependsOnTargets="_ComputeInnerBuildProjects" Returns="@(InnerOutput)">
        <MSBuild Projects="@(_InnerBuildProjects)" Condition="'@(_InnerBuildProjects)' != '' " Targets="$(InnerTargets)" BuildInParallel="$(BuildInParallel)">
            <Output ItemName="InnerOutput" TaskParameter="TargetOutputs" />
        </MSBuild>
    </Target>

    <Target Name="Build" DependsOnTargets="_SetBuildInnerTarget;DispatchToInnerBuilds" />

    <Target Name="_SetBuildInnerTarget" Returns="@(InnerOutput)">
        <PropertyGroup Condition="'$(InnerTargets)' == ''">
            <InnerTargets>Build</InnerTargets>
        </PropertyGroup>
    </Target>

    <Target Name="Clean" DependsOnTargets="_ComputeTargetFrameworkItems">
        <MSBuild Projects="@(_InnerBuildProjects)" Condition="'@(_InnerBuildProjects)' != '' " Targets="Clean" BuildInParallel="$(BuildInParallel)" />
    </Target>

    <Target Name="Rebuild" DependsOnTargets="Clean;Build" />

    <Import Project="$(CustomAfterIkvmClangCrossTargetingTargets)" Condition="'$(CustomAfterIkvmClangCrossTargetingTargets)' != '' and Exists('$(CustomAfterIkvmClangCrossTargetingTargets)')"/>

    <PropertyGroup>
        <ImportDirectoryBuildTargets Condition="'$(ImportDirectoryBuildTargets)' == ''">true</ImportDirectoryBuildTargets>
    </PropertyGroup>

    <PropertyGroup Condition="'$(ImportDirectoryBuildTargets)' == 'true' and '$(DirectoryBuildTargetsPath)' == ''">
        <_DirectoryBuildTargetsFile Condition="'$(_DirectoryBuildTargetsFile)' == ''">Directory.Build.targets</_DirectoryBuildTargetsFile>
        <_DirectoryBuildTargetsBasePath Condition="'$(_DirectoryBuildTargetsBasePath)' == ''">$([MSBuild]::GetDirectoryNameOfFileAbove($(MSBuildProjectDirectory), '$(_DirectoryBuildTargetsFile)'))</_DirectoryBuildTargetsBasePath>
        <DirectoryBuildTargetsPath Condition="'$(_DirectoryBuildTargetsBasePath)' != '' and '$(_DirectoryBuildTargetsFile)' != ''">$([System.IO.Path]::Combine('$(_DirectoryBuildTargetsBasePath)', '$(_DirectoryBuildTargetsFile)'))</DirectoryBuildTargetsPath>
    </PropertyGroup>

    <Import Project="$(DirectoryBuildTargetsPath)" Condition="'$(ImportDirectoryBuildTargets)' == 'true' and exists('$(DirectoryBuildTargetsPath)')"/>
</Project>
