<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
    <PropertyGroup>
        <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
    </PropertyGroup>

    <PropertyGroup>
        <OutputType Condition=" '$(OutputType)' == '' ">Library</OutputType>
        <UseLld Condition=" '$(UseLld)' == '' ">true</UseLld>
    </PropertyGroup>

    <PropertyGroup Condition=" '$(OutputType)' == 'exe' ">
        <TargetPrefix Condition=" '$(TargetPrefix)' == '' "></TargetPrefix>
        <TargetExt Condition=" '$(TargetExt)' == '' And '$(OutputType)' == 'exe' And $(TargetMachine.Contains('-windows-'))">.exe</TargetExt>
        <Subsystem Condition=" '$(Subsystem)' == '' And $(TargetMachine.Contains('-windows-')) ">console</Subsystem>
    </PropertyGroup>

    <PropertyGroup Condition=" '$(OutputType)' == 'library' ">
        <TargetPrefix Condition=" '$(TargetPrefix)' == '' "></TargetPrefix>
        <TargetPrefix Condition=" '$(TargetPrefix)' == '' And $(TargetMachine.Contains('-linux-')) ">lib</TargetPrefix>
        <TargetPrefix Condition=" '$(TargetPrefix)' == '' And $(TargetMachine.Contains('-apple-')) ">lib</TargetPrefix>
        <TargetExt Condition=" '$(TargetExt)' == '' And $(TargetMachine.Contains('-windows-')) ">.dll</TargetExt>
        <TargetExt Condition=" '$(TargetExt)' == '' And $(TargetMachine.Contains('-linux-')) ">.so</TargetExt>
        <TargetExt Condition=" '$(TargetExt)' == '' And $(TargetMachine.Contains('-apple-')) ">.dylib</TargetExt>
    </PropertyGroup>

    <PropertyGroup Condition=" '$(OutputType)' == 'staticlibrary' ">
        <TargetPrefix Condition=" '$(TargetPrefix)' == '' "></TargetPrefix>
        <TargetPrefix Condition=" '$(TargetPrefix)' == '' And $(TargetMachine.Contains('-linux-')) ">lib</TargetPrefix>
        <TargetPrefix Condition=" '$(TargetPrefix)' == '' And $(TargetMachine.Contains('-apple-')) ">lib</TargetPrefix>
        <TargetExt Condition=" '$(TargetExt)' == '' And $(TargetMachine.Contains('-windows-')) ">.dll</TargetExt>
        <TargetExt Condition=" '$(TargetExt)' == '' And $(TargetMachine.Contains('-linux-')) ">.so</TargetExt>
        <TargetExt Condition=" '$(TargetExt)' == '' And $(TargetMachine.Contains('-apple-')) ">.dylib</TargetExt>
    </PropertyGroup>

    <PropertyGroup>
        <ObjectExt Condition=" '$(ObjectExt)' == '' ">.obj</ObjectExt>
    </PropertyGroup>

    <PropertyGroup>
        <DebugSymbolsExt Condition=" '$(DebugSymbolsExt)' == '' And $(TargetMachine.Contains('-windows-')) ">.pdb</DebugSymbolsExt>
        <DebugSymbolsExt Condition=" '$(DebugSymbolsExt)' == '' And $(TargetMachine.Contains('-linux-')) ">.g</DebugSymbolsExt>
        <DebugSymbolsExt Condition=" '$(DebugSymbolsExt)' == '' And $(TargetMachine.Contains('-apple-')) ">.dsym</DebugSymbolsExt>
    </PropertyGroup>

    <PropertyGroup>
        <TargetName Condition=" '$(TargetName)' == '' ">$(ProjectName)</TargetName>
        <TargetFileName Condition=" '$(TargetFileName)' == '' ">$(TargetPrefix)$(TargetName)$(TargetExt)</TargetFileName>
        <DebugSymbolsFileName Condition=" '$(DebugSymbolsFileName)' == '' ">$(TargetPrefix)$(TargetName)$(DebugSymbolsExt)</DebugSymbolsFileName>

        <IntermediateTargetPath Condition=" '$(IntermediateTargetPath)' == '' ">$(IntermediateOutputPath)$(TargetFileName)</IntermediateTargetPath>
        <TargetPath Condition=" '$(TargetPath)' == '' ">$(OutputPath)$(TargetFileName)</TargetPath>

        <IntermediateDebugSymbolsPath Condition=" '$(IntermediateDebugSymbolsPath)' == '' ">$(IntermediateOutputPath)$(DebugSymbolsFileName)</IntermediateDebugSymbolsPath>
        <DebugSymbolsPath Condition=" '$(DebugSymbolsPath)' == '' ">$(OutputPath)$(DebugSymbolsFileName)</DebugSymbolsPath>
    </PropertyGroup>

    <!--
    
    GetTargetItem
    
    Externally callable target that returns information about the target being built.
    
    -->

    <PropertyGroup>
        <GetTargetItemDependsOn>
            $(GetTargetItemDependsOn)
        </GetTargetItemDependsOn>
    </PropertyGroup>

    <Target Name="GetTargetItem" DependsOnTargets="$(GetTargetItemDependsOn)" Returns="@(TargetItem)">
        <ItemGroup>
            <TargetItem Include="$(IntermediateTargetPath)">
                <TargetName>$(TargetName)</TargetName>
                <TargetFileName>$(TargetFileName)</TargetFileName>
                <DebugSymbolsFileName>$(DebugSymbolsFileName)</DebugSymbolsFileName>
                <Version>$(Version)</Version>
            </TargetItem>
        </ItemGroup>
    </Target>

    <UsingTask TaskName="IkvmClangSdkGenerateUniqueFileName" TaskFactory="RoslynCodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll">
        <ParameterGroup>
            <MetadataName ParameterType="System.String" Required="true" />
            <Extension ParameterType="System.String" Required="true" />
            <Directory ParameterType="System.String" />
            <Items ParameterType="Microsoft.Build.Framework.ITaskItem[]" Required="true" Output="true" />
        </ParameterGroup>
        <Task>
            <Using Namespace="System" />
            <Using Namespace="System.Collections.Generic" />
            <Using Namespace="System.IO" />
            <Code Language="cs" Type="Fragment">
                <![CDATA[
                var hs = new HashSet<string>();
                
                foreach (var item in Items)
                {
                    var i = 0;
                    var n = item.GetMetadata("FileName") ?? Path.ChangeExtension(Path.GetRandomFileName(), "");
                    var s = n;
                    while (hs.Add(s) == false)
                        s = n + "_" + (++i);
                    
                    item.SetMetadata(MetadataName, Path.Combine(Directory ?? "", s + Extension ?? item.GetMetadata("Extension")));
                }
            ]]>
            </Code>
        </Task>
    </UsingTask>

    <Target Name="PrepareCompile" Condition=" '@(Compile)' != '' ">
        <MakeDir Directories="$(IntermediateOutputPath)" />

        <!-- ensure members of the Compile group have necessary metadata -->
        <ItemGroup>
            <_Compile Include="@(Compile)">
                <Language Condition=" '%(Compile.Language)' == '' And '%(Extension)' == '.c' ">C</Language>
                <Language Condition=" '%(Compile.Language)' == '' And '%(Extension)' == '.cpp' ">C++</Language>
                <LanguageStandard Condition=" '%(Compile.LanguageStandard)' == '' "></LanguageStandard>
            </_Compile>
        </ItemGroup>

        <ItemGroup>
            <Compile Remove="@(Compile)" />
        </ItemGroup>

        <IkvmClangSdkGenerateUniqueFileName Items="@(_Compile)" MetadataName="OutputPath" Extension="$(ObjectExt)" Directory="$(IntermediateOutputPath)">
            <Output TaskParameter="Items" ItemName="Compile" />
        </IkvmClangSdkGenerateUniqueFileName>

        <Message Text="OutputPath: @(Compile->'%(OutputPath)')" Importance="high" />
    </Target>

    <PropertyGroup>
        <CoreCompileDependsOn>
            PrepareCompile;
            $(CoreCompileDependsOn);
        </CoreCompileDependsOn>
    </PropertyGroup>

    <Target Name="CoreCompile" DependsOnTargets="$(CoreCompileDependsOn)" Inputs="@(Compile)" Outputs="%(OutputPath)">
        <PropertyGroup>
            <_OutputPath>%(Compile.OutputPath)</_OutputPath>
        </PropertyGroup>

        <ItemGroup>
            <_Args Remove="@(_Args)" />
            <_Args Include="-c" />
            <_Args Include="-v" Condition=" '$(Verbose)' == 'true' " />
            <_Args Include="--target=$(TargetMachine)" />
            <_Args Include="-g" Condition=" '%(Compile.DebugSymbols)' == 'true' " />

            <_Args Include="-std=%(Compile.LanguageStandard)" Condition=" '%(Compile.LanguageStandard)' != '' " />
            <_Args Include="-fPIC" Condition=" '%(Compile.PositionIndependentCode)' == 'true' " />
            <_Args Include="-fms-compatibility" Condition=" '%(Compile.MsCompatibility)' == 'true' " />
            <_Args Include="-fms-compatibility-version=%(Compile.MsCompatibilityVersion)" Condition=" '%(Compile.MsCompatibilityVersion)' != '' " />

            <_SystemRootDirectories Include="%(Compile.SystemRootDirectories)" />
            <_Args Include="@(_SystemRootDirectories->'--sysroot &quot;%(Identity)&quot;')" Condition=" '@(_SystemRootDirectories)' != '' " />

            <_IncludeSystemRootDirectories Include="%(Compile.IncludeSystemRootDirectories)" />
            <_Args Include="@(_IncludeSystemRootDirectories->'-isysroot &quot;%(Identity)&quot;')" Condition=" '@(_IncludeSystemRootDirectories)' != '' " />

            <_SystemIncludeDirectories Include="%(Compile.SystemIncludeDirectories)" />
            <_Args Include="@(_SystemIncludeDirectories->'-isystem &quot;%(Identity)&quot;')" Condition=" '@(_SystemIncludeDirectories)' != '' " />

            <_IncludeDirectories Include="%(Compile.IncludeDirectories)" />
            <_Args Include="@(_IncludeDirectories->'-I &quot;%(Identity)&quot;'->Replace('\', '\\'))" Condition=" '@(_IncludeDirectories)' != '' " />

            <_PreprocessorDefinitions Include="%(Compile.PreprocessorDefinitions)" />
            <_Args Include="@(_PreprocessorDefinitions->'-D &quot;%(Identity)&quot;')" Condition=" '@(_PreprocessorDefinitions)' != '' " />

            <_AdditionalOptions Include="%(Compile.AdditionalOptions)" />
            <_Args Include="@(_AdditionalOptions)" />

            <_Args Include="-x;c" Condition=" '%(Compile.Language)' == 'C' " />
            <_Args Include="-x;c++" Condition=" '%(Compile.Language)' == 'C++' " />

            <_Args Include="&quot;%(Compile.Identity)&quot;" />

            <_Args Include="-o;&quot;$(_OutputPath)&quot;" />
        </ItemGroup>

        <Exec Command="clang @(_Args, ' ')" />
    </Target>

    <PropertyGroup>
        <LinkDependsOn>
            CoreCompile;
            BeforeLink;
            PrepareLink;
            CoreLink;
            AfterLink;
        </LinkDependsOn>
    </PropertyGroup>

    <Target Name="Link" DependsOnTargets="$(LinkDependsOn)"/>

    <Target Name="BeforeLink" />

    <Target Name="AfterLink" />

    <Target Name="PrepareLink">
        <MakeDir Directories="$(IntermediateOutputPath)" />
    </Target>

    <PropertyGroup>
        <CoreLinkDependsOn>
            CoreCompile;
            PrepareLink;
            $(CoreLinkDependsOn);
        </CoreLinkDependsOn>
    </PropertyGroup>

    <Target Name="CoreLink" DependsOnTargets="$(CoreLinkDependsOn)" Inputs="@(Compile->'%(OutputPath)')" Outputs="$(IntermediateTargetPath);$(IntermediateDebugSymbolsPath)">
        <ItemGroup>
            <_Args Remove="@(_Args)" />
            <_Args Include="-shared" Condition=" '$(OutputType)' == 'library' " />
            <_Args Include="-static" Condition=" '$(OutputType)' == 'staticlibrary' " />
            <_Args Include="-v" Condition=" '$(Verbose)' == 'true' " />
            <_Args Include="--target=$(TargetMachine)" />
            <_Args Include="-fuse-ld=lld" Condition=" '$(UseLld)' == 'true' " />
            <_Args Include="-g" Condition=" '$(DebugSymbols)' == 'true' " />

            <_SystemRootDirectories Include="$(SystemRootDirectories)" />
            <_Args Include="@(_SystemRootDirectories->'--sysroot &quot;%(Identity)&quot;')" Condition=" '@(_SystemRootDirectories)' != '' " />

            <_IncludeSystemRootDirectories Include="$(IncludeSystemRootDirectories)" />
            <_Args Include="@(_IncludeSystemRootDirectories->'-isysroot &quot;%(Identity)&quot;')" Condition=" '@(_IncludeSystemRootDirectories)' != '' " />

            <_LibraryDirectories Include="$(LibraryDirectories)" />
            <_Args Include="@(_LibraryDirectories->'-L &quot;%(Identity)&quot;')" Condition=" '@(_LibraryDirectories)' != '' " />

            <_Dependencies Include="$(Dependencies)" />
            <_Args Include="@(_Dependencies->'-l &quot;%(Identity)&quot;')" Condition=" '@(_Dependencies)' != '' " />

            <_AdditionalOptions Include="$(AdditionalOptions)" />
            <_Args Include="@(_AdditionalOptions)" />

            <_Args Include="@(Compile->'&quot;%(OutputPath)&quot;')" />

            <_Args Include="-o;&quot;$(IntermediateTargetPath)&quot;" />
        </ItemGroup>

        <Exec Command="clang @(_Args, ' ')" />
    </Target>

    <PropertyGroup>
        <CompileDependsOn>
            $(CompileDependsOn);
            Link;
        </CompileDependsOn>
    </PropertyGroup>
    
    <PropertyGroup>
        <CopyBuildOutputToOutputDirectory>true</CopyBuildOutputToOutputDirectory>
    </PropertyGroup>

    <Target Name="CopyBuildOutputToOutputDirectory" AfterTargets="CopyFilesToOutputDirectory">
        <Copy
            SourceFiles="$(IntermediateTargetPath)"
            DestinationFiles="$(TargetPath)"
            SkipUnchangedFiles="$(SkipCopyUnchangedFiles)"
            OverwriteReadOnlyFiles="$(OverwriteReadOnlyFiles)"
            Retries="$(CopyRetryCount)"
            RetryDelayMilliseconds="$(CopyRetryDelayMilliseconds)"
            UseHardlinksIfPossible="$(CreateHardLinksForCopyFilesToOutputDirectoryIfPossible)"
            UseSymboliclinksIfPossible="$(CreateSymbolicLinksForCopyFilesToOutputDirectoryIfPossible)"
            ErrorIfLinkFails="$(ErrorIfLinkFailsForCopyFilesToOutputDirectory)"
            Condition=" '$(CopyBuildOutputToOutputDirectory)' == 'true' And '$(SkipCopyBuildProduct)' != 'true' ">
            <Output TaskParameter="DestinationFiles" ItemName="FileWrites"/>
        </Copy>
        <Copy
            SourceFiles="@(IntermediateDebugSymbolsPath)"
            DestinationFiles="@(DebugSymbolsPath)"
            SkipUnchangedFiles="$(SkipCopyUnchangedFiles)"
            OverwriteReadOnlyFiles="$(OverwriteReadOnlyFiles)"
            Retries="$(CopyRetryCount)"
            RetryDelayMilliseconds="$(CopyRetryDelayMilliseconds)"
            UseHardlinksIfPossible="$(CreateHardLinksForCopyFilesToOutputDirectoryIfPossible)"
            UseSymboliclinksIfPossible="$(CreateSymbolicLinksForCopyFilesToOutputDirectoryIfPossible)"
            ErrorIfLinkFails="$(ErrorIfLinkFailsForCopyFilesToOutputDirectory)"
            Condition=" '$(CopyOutputSymbolsToOutputDirectory)' == 'true' And '$(SkipCopyingSymbolsToOutputDirectory)' != 'true' ">
            <Output TaskParameter="DestinationFiles" ItemName="FileWrites"/>
        </Copy>
    </Target>

    <Target Name="CreateManifestResourceNames" Condition=" '@(EmbeddedResource)' != '' " DependsOnTargets="$(CreateManifestResourceNamesDependsOn)">
        <ItemGroup>
            <_Temporary Remove="@(_Temporary)" />
        </ItemGroup>
    </Target>

</Project>
