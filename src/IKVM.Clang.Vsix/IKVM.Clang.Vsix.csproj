<Project>

    <PropertyGroup>
        <Configuration Condition="'$(Configuration)' == ''">Debug</Configuration>
        <Platform Condition="'$(Platform)' == ''">AnyCPU</Platform>
        <BaseOutputPath>$(MSBuildThisFileDirectory)bin\</BaseOutputPath>
        <BaseIntermediateOutputPath>$(MSBuildThisFileDirectory)obj\</BaseIntermediateOutputPath>
        <IntermediateOutputPath>$(BaseIntermediateOutputPath)$(Configuration)\</IntermediateOutputPath>
        <OutputPath>$(BaseOutputPath)$(Configuration)\</OutputPath>
        <RootNamespace>IKVM.Clang.Vsix</RootNamespace>
    </PropertyGroup>

    <Import Sdk="Microsoft.NET.Sdk" Project="Sdk.props" />

    <PropertyGroup>
        <TargetFramework>net472</TargetFramework>
        <IsPackable>false</IsPackable>
        <TargetVsixContainerName>IKVM.Clang.vsix</TargetVsixContainerName>
        <GeneratePkgDefFile>true</GeneratePkgDefFile>
        <IncludeAssemblyInVSIXContainer>true</IncludeAssemblyInVSIXContainer>
        <IncludeDebugSymbolsInVSIXContainer>true</IncludeDebugSymbolsInVSIXContainer>
        <IncludeDebugSymbolsInLocalVSIXDeployment>true</IncludeDebugSymbolsInLocalVSIXDeployment>
        <StartAction>Program</StartAction>
        <StartProgram>$(DevEnvDir)devenv.exe</StartProgram>
        <StartArguments>/rootSuffix Exp</StartArguments>
    </PropertyGroup>

    <ItemGroup>
        <PackageReference Include="IKVM.Core.MSBuild" Version="0.1.28">
            <PrivateAssets>all</PrivateAssets>
            <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
        </PackageReference>
        <PackageReference Include="Microsoft.VisualStudio.ProjectSystem" Version="15.8.243" />
        <PackageReference Include="Microsoft.VisualStudio.ProjectSystem.Sdk" Version="15.8.243" />
        <PackageReference Include="Microsoft.VisualStudio.ProjectSystem.SDK.Tools" Version="15.8.243" />
        <PackageReference Include="Microsoft.VisualStudio.Shell.15.0" Version="17.5.33428.388" />
        <PackageReference Include="Microsoft.VisualStudio.SDK" Version="17.5.33428.388">
            <ExcludeAssets>runtime</ExcludeAssets>
        </PackageReference>
        <PackageReference Include="Microsoft.VSSDK.BuildTools" Version="17.5.4074">
            <PrivateAssets>all</PrivateAssets>
            <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
        </PackageReference>
    </ItemGroup>

    <ItemDefinitionGroup>
        <VSIXSourceItem>
            <InProject>false</InProject>
            <InstallRoot>MSBuild</InstallRoot>
            <VSIXSubPath>CustomProjectSystems\Clang\%(RelativeDir)</VSIXSubPath>
        </VSIXSourceItem>
    </ItemDefinitionGroup>

    <ItemGroup>
        <Compile Update="VSPackage.Designer.cs">
            <DesignTime>True</DesignTime>
            <AutoGen>True</AutoGen>
            <DependentUpon>VSPackage.resx</DependentUpon>
        </Compile>
        <Compile Update="Resources.Designer.cs">
            <DependentUpon>Resources.resx</DependentUpon>
            <DesignTime>True</DesignTime>
            <AutoGen>True</AutoGen>
        </Compile>
    </ItemGroup>

    <ItemGroup>
        <EmbeddedResource Update="Resources.resx">
            <SubType>Designer</SubType>
            <LastGenOutput>Resources.Designer.cs</LastGenOutput>
            <Generator>ResXFileCodeGenerator</Generator>
        </EmbeddedResource>
        <EmbeddedResource Update="VSPackage.resx">
            <MergeWithCTO>true</MergeWithCTO>
            <Generator>ResXFileCodeGenerator</Generator>
            <LastGenOutput>VSPackage.Designer.cs</LastGenOutput>
        </EmbeddedResource>
    </ItemGroup>

    <Import Sdk="Microsoft.NET.Sdk" Project="Sdk.targets" />
    <Import Project="$(VSToolsPath)\VSSDK\Microsoft.VsSDK.targets" Condition="Exists('$(VSToolsPath)\VSSDK\Microsoft.VsSDK.targets')" />

    <UsingTask TaskName="PostUpdateVsixManifest" TaskFactory="RoslynCodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll">
        <ParameterGroup>
            <ManifestFile ParameterType="System.String" Required="true" />
            <Version ParameterType="System.String" Required="true" />
            <Experimental ParameterType="System.String" Required="true" />
            <AllUsers ParameterType="System.String" Required="true" />
        </ParameterGroup>
        <Task>
            <Using Namespace="System" />
            <Using Namespace="System.Xml.Linq" />
            <Using Namespace="System.IO" />
            <Code Language="cs" Type="Fragment">
                <![CDATA[
                var ns = (XNamespace)"http://schemas.microsoft.com/developer/vsx-schema/2011";
                var x = XDocument.Load(ManifestFile);
                x.Root.Element(ns + "Metadata").Element(ns + "Identity").SetAttributeValue("Version", Version);
                x.Root.Element(ns + "Installation").SetAttributeValue("Experimental", Experimental);
                x.Root.Element(ns + "Installation").SetAttributeValue("AllUsers", AllUsers);
                x.Save(ManifestFile);
            ]]>
            </Code>
        </Task>
    </UsingTask>

    <Target Name="PostUpdateVsixManifest" BeforeTargets="ValidateVsixManifest">
        <PropertyGroup>
            <Experimental>false</Experimental>
            <Experimental Condition=" '$(PreReleaseLabel)' != '' ">true</Experimental>
            <AllUsers>false</AllUsers>
            <AllUsers Condition=" '$(BuildingInsideVisualStudio)' == 'true' ">true</AllUsers>
        </PropertyGroup>
        <PostUpdateVsixManifest ManifestFile="$(IntermediateVsixManifest)" Version="$(FileVersion)" Experimental="$(Experimental)" AllUsers="true" />
    </Target>

</Project>
